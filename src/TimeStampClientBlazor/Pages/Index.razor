@page "/"
@using System.IO
@using System.Text
@inject IJSRuntime JSRuntime

<h1>TimeStampClientBlazor</h1>

<h3>Upload Files</h3>

<p>
    <label>
        Upload file up to @maxFileSize bytes:
        <InputFile OnChange="@LoadFiles" />
    </label>
</p>

<p>@exceptionMessage</p>

@if (isLoading)
{
    <p>Loading...</p>
}

<ul>
    @foreach (var (file, content) in loadedFiles)
    {
        <li>
            <ul>
                <li>Name: @file.Name</li>
                <li>Last modified: @file.LastModified.ToString()</li>
                <li>Size (bytes): @file.Size</li>
                <li>Content type: @file.ContentType</li>
                <li>Content: @content</li>
            </ul>
        </li>
    }
</ul>

@code {
    private Dictionary<IBrowserFile, string> loadedFiles =
        new Dictionary<IBrowserFile, string>();
    private long maxFileSize = 1024 * 1000;
    private bool isLoading;
    string exceptionMessage;

    async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        loadedFiles.Clear();
        exceptionMessage = string.Empty;

        try
        {
            using var reader =
                new StreamReader(e.File.OpenReadStream(maxFileSize));

            loadedFiles.Add(e.File, await reader.ReadToEndAsync());
        }
        catch (Exception ex)
        {
            exceptionMessage = ex.Message;
        }

        isLoading = false;

        Stream stream = e.File.OpenReadStream();
        string fileName = e.File.Name;

        MemoryStream ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        ms.Position = 0;
        var timeStampToken = await Disig.TimeStampClient.TimeStampClient.RequestTimeStampTokenUpdatedAsync("https://localhost:5001/tsa", ms);
        stream.Dispose();
        ms.Position = 0;
        await SaveToAsicSimple(fileName, timeStampToken, ms);
    }

    async Task DownloadAsics(string fileName, MemoryStream fileInput)
    {
        byte[] file = fileInput.ToArray();
        await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", Path.GetFileNameWithoutExtension(fileName) + ".asics", "application/vnd.etsi.asic-s+zip", file);
    }

    async Task SaveToAsicSimple(string inputName, Disig.TimeStampClient.TimeStampToken timeStampToken, Stream inputStream)
    {
        using (Ionic.Zip.ZipFile zipFile = new Ionic.Zip.ZipFile(UTF8Encoding.UTF8))
        {
            zipFile.ParallelDeflateThreshold = -1;
            zipFile.UseZip64WhenSaving = Ionic.Zip.Zip64Option.Never;
            zipFile.EmitTimesInUnixFormatWhenSaving = false;
            zipFile.EmitTimesInWindowsFormatWhenSaving = false;
            zipFile.Comment = @"mimetype=application/vnd.etsi.asic-s+zip";

            using (MemoryStream ms = new MemoryStream())
            {
                zipFile.AddEntry(@"mimetype", System.Text.UTF8Encoding.UTF8.GetBytes(@"application/vnd.etsi.asic-s+zip"));
                zipFile.AddEntry(inputName, inputStream);
                zipFile.AddEntry(@"META-INF/timestamp.tst", timeStampToken.ToByteArray());
                zipFile.Save(ms);
                
                await DownloadAsics(inputName, ms);
            }
        }
    }
}
